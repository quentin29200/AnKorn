<?php

namespace PA\AnnonceBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * AnnonceRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AnnonceRepository extends EntityRepository
{
	public function recupannoncesoffre()
	{
		$qb = $this->createQueryBuilder('a');
 		$qb
   			->where('a.an_dateSupression IS NULL')
        ->andWhere('a.an_publie = true')
        ->andWhere("a.an_type = 'offre'")
    		->orderBy('a.an_datePublication', 'DESC')
  		;

  		return $qb
   			->getQuery()
    		->getResult()
  		;
	}
  public function recupannoncesdemande()
  {
    $qb = $this->createQueryBuilder('a');
    $qb
        ->where('a.an_dateSupression IS NULL')
        ->andWhere('a.an_publie = true')
        ->andWhere("a.an_type = 'demande'")
        ->orderBy('a.an_datePublication', 'DESC')
      ;

      return $qb
        ->getQuery()
        ->getResult()
      ;
  }

  public function recupmesannonces($id)
  {
    $qb = $this->createQueryBuilder('a');
    $qb
        ->where('a.an_dateSupression IS NULL')
        ->andWhere('a.an_user = :user')
        ->setParameter('user', $id)
        ->orderBy('a.an_datePublication', 'DESC')
      ;

      return $qb
        ->getQuery()
        ->getResult()
      ;
  }

  public function recupannonces()
  {
    $qb = $this->createQueryBuilder('a');
    $qb
        ->where('a.an_dateSupression IS NULL')
        ->andWhere('a.an_publie = true')
        ->orderBy('a.an_datePublication', 'DESC')
      ;

      return $qb
        ->getQuery()
        ->getResult()
      ;
  }

  /**
     * Compte le nombre de lignes 
     * @param array $options
     * @return integer
     */
  public function count(array $options = null) {
        $qb = $this->createQueryBuilder($this->_entityName);
        $qb->select($qb->expr()->count($this->_entityName));
        if ($options != null) {
            foreach ($options as $option => $valeur) {
                if (!is_null($valeur)) {
                  if ($option == "an_titre") {
                    $qb->andWhere($this->_entityName . '.' . $option . " LIKE '%" . $valeur . "%'");
                  } else if ($option == "an_secteur") {
                      foreach ($valeur as $secteur) {
                         $qb->andWhere($this->_entityName . '.' . $option . ' = ' . $secteur);
                      }
                  } else {
                    $qb->andWhere($this->_entityName . '.' . $option . ' = ' . $valeur);
                  }
                }
            }
        }
        return $qb->getQuery()->getSingleScalarResult();
  }

  public function pagination($maxResults, $page = 1, $sort = null, $order = null,array $options = null) {
        $qb = $this->createQueryBuilder($this->_entityName);
        if ($options != null) {
            foreach ($options as $option => $valeur) {
                if (!is_null($valeur)) {
                  if ($option == "an_titre") {
                    $qb->andWhere($this->_entityName . '.' . $option . " LIKE '%" . $valeur . "%'");
                  } else if ($option == "an_secteur") {
                      foreach ($valeur as $secteur) {
                         $qb->andWhere($this->_entityName . '.' . $option . ' = ' . $secteur);
                      }
                  } else {
                    $qb->andWhere($this->_entityName . '.' . $option . ' = ' . $valeur);
                  }
                }
            }
        } 
        if ($sort != null) $qb->orderBy($this->_entityName . '.' . $sort, $order);
        $query = $qb->getQuery();
        $query->setFirstResult(($page - 1) * $maxResults)
                ->setMaxResults($maxResults);
        return $query->getResult();
  }

  /*public function searchannonces($page, $nom, $sect, $type, $cat)
  {
    $qbnom = '';
    $qbsect = '';
    $qbtype = '';
    $qbcat = '';

    $qbtotal = 'a.an_dateSupression IS NULL AND a.an_publie = true';

    if (!is_null($nom)) {
           $qbtotal .= " AND a.an_titre LIKE '%".$nom."%'";
    }

    if (!empty($sect)) {
            $first = true;
            foreach ($sect as $secteur) {
                if ($first) {
                    $qbtotal .= ' AND ';
                    $first = false;
                } else {
                     $qbtotal .= ' OR ';
                }
                   $qbtotal .= " a.an_secteur = '" .$secteur."'";
            }
    }

    if (!is_null($type)) {
           $qbtotal .= " AND a.an_type = '" .$type."'"; 
    }
    if (!is_null($cat)) {
           $qbtotal .= ' AND a.an_categorie = ' .$cat;
    }

    $qb = $this->createQueryBuilder('a');
    $qb
        ->select('a')
        ->where($qbtotal)
        ->orderBy('a.an_datePublication', 'DESC')
        ->setFirstResult(($page-1) * 21)
        ->setMaxResults(21)
      ;
 
    return new Paginator($qb);
  }*/
}
